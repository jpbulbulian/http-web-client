"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});const qs_1=__importDefault(require("qs")),ACCESS_TOKEN="access",REFRESH_TOKEN="refresh",isJSON=e=>e.headers?.get("Content-Type")?.startsWith("application/json")?e.json():e.text();function isValidURL(e){try{return Boolean(new URL(e))}catch{return!1}}class HttpWebClient{constructor(e="",t){this._base=e,this._refreshEndpoint=t,this._accessToken=localStorage.getItem("access"),this._refreshToken=localStorage.getItem("refresh"),this.hasAccessToken=()=>!!this._accessToken,this.hasRefreshToken=()=>!!this._refreshToken,this.setAccessToken=e=>{this._accessToken=e,e?localStorage.setItem("access",e):localStorage.removeItem("access")},this.setRefreshToken=e=>{this._refreshToken=e,e?localStorage.setItem("refresh",e):localStorage.removeItem("refresh")},this.setTokens=({access:e,refresh:t})=>{this.setAccessToken(e),this.setRefreshToken(t)},this.removeTokens=()=>(this.setAccessToken(null),this.setRefreshToken(null),null),this._refresh=()=>fetch(this._base+this._refreshEndpoint,{method:"POST",headers:{Authorization:`Bearer ${this._refreshToken}`}}).then((e=>{if(e.ok)return isJSON(e);throw 401===e.status&&this.removeTokens(),Error(e.statusText)})).then((({access:e,refresh:t})=>{this.setAccessToken(e),t&&this.setRefreshToken(t)})),this._method=(e,t)=>(s,h)=>this._fetcher(s,{...h,method:e,auth:t}),this._methodWithBody=(e,t)=>(s,h,o)=>this._fetcher(s,{...o,method:e,body:h,auth:t}),this._get=this._method("GET",!0),this.get=this._method("GET"),this._head=this._method("HEAD",!0),this.head=this._method("HEAD"),this._post=this._methodWithBody("POST",!0),this.post=this._methodWithBody("POST"),this._put=this._methodWithBody("PUT",!0),this.put=this._methodWithBody("PUT"),this._patch=this._methodWithBody("PATCH",!0),this.patch=this._methodWithBody("PATCH"),this._delete=this._method("DELETE",!0),this.delete=this._method("DELETE"),this.options=this._method("OPTIONS"),this.connect=this._method("CONNECT"),this.trace=this._method("TRACE")}_fetcher(e,t){let{body:s}=t;const{method:h,headers:o={},query:i,auth:r}=t;s&&!o["Content-Type"]&&(s=JSON.stringify(s),o["Content-Type"]="application/json"),r&&this.hasAccessToken()&&(o.Authorization=`Bearer ${this._accessToken}`);let n=isValidURL(e)?e:this._base+e;return i&&(n+=`?${qs_1.default.stringify(i)}`),fetch(n,{method:h,headers:o,body:s}).then((s=>{if(s.ok)return isJSON(s);if(r&&401===s.status&&(this.hasAccessToken()&&this.setAccessToken(null),this._refreshEndpoint&&this.hasRefreshToken()))return this._refresh().then((()=>this._fetcher(e,t)));throw Error(s.statusText)}))}}exports.default=HttpWebClient;