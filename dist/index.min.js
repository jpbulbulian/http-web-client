"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});const qs_1=__importDefault(require("qs")),CONTENT_TYPE={"Content-Type":"application/json"},ACCESS_TOKEN="access",REFRESH_TOKEN="refresh",withQuery=e=>e?`?${qs_1.default.stringify(e)}`:"",isJSON=e=>e.headers?.get("content-type")?.startsWith("application/json")?e.json():e.text();class HttpWebClient{constructor(e,t){this.base=e,this.refreshPath=t,this.accessToken=localStorage.getItem("access"),this.refreshToken=localStorage.getItem("refresh"),this.hasAccessToken=()=>!!this.accessToken,this.hasRefreshToken=()=>!!this.refreshToken,this.setAccessToken=e=>{this.accessToken=e,e?localStorage.setItem("access",e):localStorage.removeItem("access")},this.setRefreshToken=e=>{this.refreshToken=e,e?localStorage.setItem("refresh",e):localStorage.removeItem("refresh")},this.setTokens=({access:e,refresh:t})=>{this.setAccessToken(e),this.setRefreshToken(t)},this.removeTokens=()=>(this.setAccessToken(null),this.setRefreshToken(null),null),this.authHeader=()=>this.hasAccessToken()?{Authorization:`Bearer ${this.accessToken}`}:{},this.fetcher=(e,{method:t,body:s,query:h})=>fetch(this.base+e+withQuery(h),{method:t,headers:{...CONTENT_TYPE,...this.authHeader()},body:JSON.stringify(s)}).then((r=>{if(r.ok)return isJSON(r);if(401===r.status&&(this.hasAccessToken()&&this.setAccessToken(null),this.hasRefreshToken()))return this.refresh().then((()=>this.fetcher(e,{method:t,body:s,query:h})));throw Error(r.statusText)})),this.refresh=()=>fetch(this.base+this.refreshPath,{method:"POST",headers:{...CONTENT_TYPE,Authorization:`Bearer ${this.refreshToken}`}}).then((e=>{if(e.ok)return isJSON(e);throw 401===e.status&&this.removeTokens(),Error(e.statusText)})).then((({access:e,refresh:t})=>{this.setAccessToken(e),t&&this.setRefreshToken(t)})),this.get=(e,t)=>this.fetcher(e,{...t,method:"GET"}),this.post=(e,t,s)=>this.fetcher(e,{...s,method:"POST",body:t}),this.put=(e,t,s)=>this.fetcher(e,{...s,method:"PUT",body:t}),this.delete=(e,t)=>this.fetcher(e,{...t,method:"DELETE"})}}exports.default=HttpWebClient;